% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/ATL08_canopy_h5_gridStat.R
\name{ATL08_canopy_h5_gridStat}
\alias{ATL08_canopy_h5_gridStat}
\title{Rasterize ATL08 canopy attributes from h5 files at large scale}
\usage{
ATL08_canopy_h5_gridStat(
  atl08_path,
  metrics = c("h_canopy", "canopy_rh_conf", "h_median_canopy_abs", "h_min_canopy",
    "h_mean_canopy_abs", "h_median_canopy", "h_canopy_abs", "toc_roughness",
    "h_min_canopy_abs", "h_dif_canopy", "h_canopy_quad", "h_canopy_20m", "n_ca_photons",
    "photon_rate_can", "centroid_height", "canopy_h_metrics_abs", "h_mean_canopy",
    "subset_can_flag", "canopy_h_metrics", "n_toc_photons", "h_max_canopy_abs",
    "h_canopy_uncertainty", "canopy_openness", "h_max_canopy", "segment_cover"),
  beam = c("gt1l", "gt1r", "gt2l", "gt2r", "gt3l", "gt3r"),
  out_root,
  ul_lat,
  ul_lon,
  lr_lat,
  lr_lon,
  res,
  creation_options = def_co,
  agg_function = default_agg_function,
  agg_join = default_agg_join,
  finalizer = default_finalizer
)
}
\arguments{
\item{atl08_path}{CharacterVector. The directory paths where the ATL08 H5 files are stored;}

\item{metrics}{CharacterVector. A vector of canopy attributes available from ATL08 product (e.g. "h_canopy")}

\item{out_root}{Character. The root name for the raster output files, the pattern is {out_root}_{metric}_{count/m1/m2/m3/m4}.tif. This should include the full path for the file.}

\item{ul_lat}{Numeric. Upper left latitude for the bounding box}

\item{ul_lon}{Numeric. Upper left longitude for the bounding box}

\item{lr_lat}{Numeric. Lower right latitude for the bounding box}

\item{lr_lon}{Numeric. Lower right longitude for the bounding box}

\item{res}{NumericVector. Resolution lon lat for the output raster in coordinates decimal degrees}

\item{creation_options}{CharacterVector. The GDAL creation options for the tif file. Default c("COMPRESS=PACKBITS", "BIGTIFF=IF_SAFER", "TILED=YES", "BLOCKXSIZE=512", "BLOCKYSIZE=512") will create BIGTIFF if needed, with DEFLATE compression and tiled by 512x512 pixels.}

\item{agg_function}{Formula function-like. An aggregate function which should return a data.table with the aggregate statistics}

\item{agg_join}{Function. A function to merge two different agg objects.}

\item{finalizer}{List<name, formula>. A list with the final raster names and the formula which uses the base statistics.}
}
\value{
Nothing. It outputs multiple raster tif files to the out_root specified path.
}
\description{
This function will read multiple ATL08 H5 files and create a stack of raster layers: count, and 1st, 2nd, 3rd and 4th moments (count, m1, m2, m3 and m4) for each metric selected, from which we can calculate statistics such as Mean, SD, Skewness and Kurtosis.
}
\details{
This function will create seven different aggregate statistics
(n, m1, m2, m3, m4, min, max). m1 to m4 are the central moments.
One can calculate mean, standard deviation, skewness and kurtosis
with the following formulas according to Terriberry (2007) and
\insertCite{Joanes1998;textual}{rICESat2}:

\deqn{ \bar{x} = m_1 }{mean = m1}

\deqn{ s = \sqrt{\frac{m_2}{n - 1}} }{sd = sqrt(m2/(n - 1))}

\deqn{ g_1 = \frac{\sqrt{n} \cdot m_3}{m_2^{1.5}} }{ g1 = (sqrt(n) * m3) / (m2^1.5)}

\deqn{ g_2 = \frac{n \cdot m_4}{m_2^2} - 3 }{g2 = (n * m4) / (m2 * m2) - 3.0}

\deqn{ skewness = \frac{\sqrt{n(n - 1)}}{n-2} g_1 }{skewness = sqrt((n * (n - 1))) * g1 / (n - 2)}

\deqn{ kurtosis = \frac{n - 1}{(n - 2)(n - 3)}[(n + 1)g_2 + 6] }{kurtosis = ((n - 1) / ((n - 2) * (n - 3))) * ((n + 1) * g2 + 6)}

The `agg_function` is a formula which return a data.table with the
aggregate function to perform over the data.
The default is:

```{r, eval=FALSE}
~data.table(
    n = length(x),
    M1 = mean(x,na.rm = T),
    M2 = e1071::moment(x, order = 2, center = TRUE, na.rm = T) * length(x),
    M3 = e1071::moment(x, order = 3, center = TRUE, na.rm = T) * length(x),
    M4 = e1071::moment(x, order = 4, center = TRUE, na.rm = T) * length(x),
    min = min(x, na.rm=T),
    max = max(x, na.rm=T)
  )
```

The `agg_join` is a function to merge two data.table aggregates
from the `agg_function`. Since the h5 files will be aggregated
one by one, the statistics from the different h5 files should
have a function to merge them. The default function is:

```{r, eval=FALSE}
function(x1, x2) {
    combined = data.table()
    x1$n[is.na(x1$n)] = 0
    x1$M1[is.na(x1$M1)] = 0
    x1$M2[is.na(x1$M2)] = 0
    x1$M3[is.na(x1$M3)] = 0
    x1$M4[is.na(x1$M4)] = 0
    x1$max[is.na(x1$max)] = -Inf
    x1$min[is.na(x1$min)] = Inf

    combined$n = x1$n + x2$n

    delta = x2$M1 - x1$M1
    delta2 = delta * delta
    delta3 = delta * delta2
    delta4 = delta2 * delta2

    combined$M1 = (x1$n * x1$M1 + x2$n * x2$M1) / combined$n

    combined$M2 = x1$M2 + x2$M2 +
      delta2 * x1$n * x2$n / combined$n

    combined$M3 = x1$M3 + x2$M3 +
      delta3 * x1$n * x2$n * (x1$n - x2$n) / (combined$n * combined$n)
    combined$M3 = combined$M3 + 3.0 * delta * (x1$n * x2$M2 - x2$n * x1$M2) / combined$n

    combined$M4 = x1$M4 + x2$M4 + delta4 * x1$n * x2$n * (x1$n * x1$n - x1$n * x2$n + x2$n * x2$n) /
      (combined$n * combined$n * combined$n)
    combined$M4 = combined$M4 + 6.0 * delta2 * (x1$n * x1$n * x2$M2 + x2$n * x2$n * x1$M2) / (combined$n * combined$n) +
      4.0 * delta * (x1$n * x2$M3 - x2$n * x1$M3) / combined$n

    combined$min = pmin(x1$min, x2$min, na.rm=F)
    combined$max = pmax(x1$max, x2$max, na.rm=F)
    return(combined)
}
```

The `finalizer` is a list of formulas to generate the final
rasters based on the intermediate statistics from the previous
functions. The default `finalizer` will calculate the `sd`,
`skewness` and `kurtosis` based on the `M2`, `M3`, `M4` and `n`
values. It is defined as:

```{r, eval=FALSE}
list(
  sd = ~sqrt(M2/(n - 1)),
  skew = ~sqrt((n * (n - 1))) * ((sqrt(n) * M3) / (M2^1.5)) / (n - 2),
  kur = ~((n - 1) / ((n - 2) * (n - 3))) * ((n + 1) * ((n * M4) / (M2^2) - 3.0) + 6)
)
```
}
\examples{
# Specifying the path to GEDI leveatl08_canopy_dt data (zip file)
library(rICESat2Veg)
library(data.table)

# Specifying the path to ATL08 file (zip file)
outdir <- tempdir()

atl08_zip <- system.file("extdata",
  "ATL08_20220401221822_01501506_005_01.zip",
  package = "rICESat2Veg"
)

# Unzipping ATL08 file
atl08_path <- unzip(atl08_zip, exdir = outdir)

# Bounding rectangle coordinates
ul_lat <- -13.72016
ul_lon <- -44.14000
lr_lat <- -13.74998
lr_lon <- -44.11009

res <- 100 # meters
lat_to_met_factor <- 1 / 110540
lon_to_met_factor <- 1 / 111320
xres <- lon_to_met_factor * res
yres <- lat_to_met_factor * res

agg_function <- ~ data.table(
  min = min(x),
  max = max(x),
  sum = sum(x),
  n = length(x)
)

agg_join <- function(agg1, agg2) {
  agg1[is.na(agg1)] <- 0
  data.table(
    min = pmin(agg1$min, agg2$min),
    max = pmax(agg1$max, agg2$max),
    sum = agg1$sum + agg2$sum,
    n = agg1$n + agg2$n
  )
}

finalizer <- list(
  mean = "sum/n",
  range = "max-min"
)

ATL08_canopy_h5_gridStat(
  atl08_path = outdir,
  metrics = c("h_canopy"),
  out_root = file.path(outdir, "output"),
  ul_lat = ul_lat,
  ul_lon = ul_lon,
  lr_lat = lr_lat,
  lr_lon = lr_lon,
  res = c(xres, -yres),
  creation_options = c(
    "COMPRESS=DEFLATE",
    "BIGTIFF=IF_SAFER",
    "TILED=YES",
    "BLOCKXSIZE=512",
    "BLOCKYSIZE=512"
  ),
  agg_function = agg_function,
  agg_join = agg_join,
  finalizer = finalizer
)

close(leveatl08_canopy_dt)

}
\references{
\insertAllCited{}

Terriberry, Timothy B. (2007), Computing Higher-Order Moments Online, archived from the original on 23 April 2014, retrieved 5 May 2008
}
